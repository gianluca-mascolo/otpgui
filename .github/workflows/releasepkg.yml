name: Build Artifact

on:
  push:
    tags: [ '[0-9]+.[0-9]+.[0-9]+' ]

jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
      - name: Python Poetry Action
        uses: abatilo/actions-poetry@v2.1.3
      - name: Bump version
        run: poetry version ${GITHUB_REF##refs/tags/}
      - name: Install dependencies
        run: poetry build -f wheel
      - name: Setup Arch Docker
        run: |
          echo "USER_UID=$(id -u)" > .env
          docker-compose build archpy
      - name: Build Arch Artifact
        run: |
          GIT_TAG=${GITHUB_REF##refs/tags/} make arch-clean
          GIT_TAG=${GITHUB_REF##refs/tags/} make arch-pkg
          ls -la archbuild/
          id
      - name: Test Arch Artifact
        run: |
          ls -la archbuild/
          GIT_TAG=${GITHUB_REF##refs/tags/} make arch-install
      - name: Prepare AUR upload
        run: |
          [ -d ~/.ssh ] || mkdir -p [ ~/.ssh ]
          chmod 0700 ~/.ssh
          echo "${{ secrets.AUR_SSH_KEY }}" | base64 -d > ~/.ssh/aur
          chmod 0600 ~/.ssh/aur
          ssh-keyscan -H aur.archlinux.org > ~/.ssh/known_hosts
          chmod 0600 ~/.ssh/known_hosts
          ssh-agent > ~/.ssh/agent
          source ~/.ssh/agent
          ssh-add ~/.ssh/aur
          echo -e 'Host aur.archlinux.org\n  User aur\n  IdentityFile ~/.ssh/aur\n  ConnectTimeout 10' > ~/.ssh/config
          ssh aur.archlinux.org list-repos
